---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { waitlistUrl } from '../../waitlist';

const jobs = await getCollection('job-postings');
const sortedJobs = jobs.sort(
  (a, b) => b.data.datePosted.getTime() - a.data.datePosted.getTime()
);

const title = 'Work at Sokkel';
const description =
  'Join us in building the foundation for modern application management.';
---

<Layout
  meta={{
    title,
    description,
    path: '/jobs', // Assuming this is the path
  }}
  header={{
    show: true,
    links: [
      { text: 'Home', href: '/', wideOnly: false },
      { text: 'About us', href: '/about-us', wideOnly: false },
      { text: 'Join waitlist', href: waitlistUrl, wideOnly: true },
    ],
  }}
  footer={{ show: true }}
>
  <main>
    <section class="intro">
      <h1>{title}</h1>
      <div class="pitch">
        <p>
          We believe everyone deserves to do work that matters. Sokkel exists to
          make that real for the people who build things. We are building the
          foundation and building blocks for managing your applications,
          smooooothly.
        </p>
        <p>
          We are looking for people who care about the outcome, not just the
          output. Join us.
        </p>
      </div>
    </section>

    <section class="jobs">
      <h2>Open Positions</h2>
      <div class="job-list" id="job-list">
        {
          sortedJobs.map((job) => (
            <a href={`/jobs/${job.slug}`} class="job-card">
              <span class="job-title">{job.data.title}</span>
              <span class="job-location">{job.data.location.name}</span>
            </a>
          ))
        }
      </div>
    </section>
  </main>
</Layout>

<script>
  let selectedIndex = -1;
  const jobList = document.getElementById('job-list');
  const jobCards = jobList
    ? Array.from(jobList.getElementsByClassName('job-card'))
    : [];

  function updateSelection() {
    jobCards.forEach((card, index) => {
      if (index === selectedIndex) {
        card.classList.add('selected');
        // Smooth scroll to the selected item if needed, or just standard scroll
        (card as HTMLElement).scrollIntoView({
          block: 'nearest',
          behavior: 'smooth',
        });
        (card as HTMLElement).focus();
      } else {
        card.classList.remove('selected');
      }
    });
  }

  document.addEventListener('keydown', (event) => {
    // Prevent default scrolling for navigation keys
    const isNavKey =
      ['j', 'k', 'Enter', 'l'].includes(event.key) ||
      ((event.ctrlKey || event.metaKey) && ['n', 'p'].includes(event.key));

    if (isNavKey) {
      // Don't interfere if user is typing in an input (though none exist here yet)
      if (
        document.activeElement?.tagName === 'INPUT' ||
        document.activeElement?.tagName === 'TEXTAREA'
      ) {
        return;
      }
    }

    if (
      event.key === 'j' ||
      ((event.ctrlKey || event.metaKey) && event.key === 'n')
    ) {
      if (selectedIndex < jobCards.length - 1) {
        selectedIndex++;
        updateSelection();
      }
    } else if (
      event.key === 'k' ||
      ((event.ctrlKey || event.metaKey) && event.key === 'p')
    ) {
      if (selectedIndex > 0) {
        selectedIndex--;
        updateSelection();
      } else if (selectedIndex === -1 && jobCards.length > 0) {
        // If nothing selected and press up/k, select last one? Or first?
        // Usually J goes down (select first), K goes up.
        // If unselected, K doing nothing is fine, or select bottom.
        // Let's stick to J starts selection at top.
      }
    } else if (event.key === 'Enter' || event.key === 'l') {
      if (selectedIndex !== -1) {
        (jobCards[selectedIndex] as HTMLAnchorElement).click();
      }
    }
  });
</script>

<style>
  main {
    margin-top: calc(var(--spacing) * 20);
    margin-bottom: calc(var(--spacing) * 20);
    padding-inline: calc(var(--spacing) * 6);
    max-width: 65ch;
    margin-inline: auto;
    display: flex;
    flex-direction: column;
    gap: calc(var(--spacing) * 20);

    @media (min-width: 40rem) {
      padding-inline: calc(var(--spacing) * 10);
    }
  }

  .intro {
    display: flex;
    flex-direction: column;
    gap: calc(var(--spacing) * 6);

    h1 {
      font-size: var(--text-3xl-font-size);
      line-height: var(--text-3xl-line-height);
      font-weight: var(--font-weight-extrabold);
      margin: 0;
    }

    .pitch {
      display: flex;
      flex-direction: column;
      gap: calc(var(--spacing) * 4);
      font-size: var(--text-lg-font-size);
      line-height: var(--text-lg-line-height);
      max-width: 45ch;
    }
  }

  .jobs {
    display: flex;
    flex-direction: column;
    gap: calc(var(--spacing) * 6);

    h2 {
      font-size: var(--text-xl-font-size);
      font-weight: var(--font-weight-bold);
      margin: 0;
    }
  }

  .job-list {
    display: flex;
    flex-direction: column;
    gap: calc(var(--spacing) * 4);
  }

  .job-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: calc(var(--spacing) * 6);
    background-color: var(--color-base-background);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-xl);
    text-decoration: none;
    color: inherit;
    transition: background-color 0.2s;

    &:hover,
    &.selected {
      background-color: var(--color-gray-50);
      border-color: var(--color-gray-400);
    }

    &:focus-visible,
    &.selected {
      outline: 2px solid var(--color-base-primary);
      outline-offset: 2px;
    }
  }

  .job-title {
    font-weight: var(--font-weight-bold);
    font-size: var(--text-lg-font-size);
  }

  .job-location {
    color: var(--color-gray-600); /* Guessing generic gray */
  }
</style>
