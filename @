---
import { client } from "../sanity-client.ts";
import imageUrlBuilder from "@sanity/image-url";

const builder = imageUrlBuilder(client);

function urlFor(source) {
  return builder.image(source);
}

const cards = await client.fetch(`
  *[_type == 'statement'] {
    backgroundImage,
    statement,
    source,
    answers
  }
`);

const setStyle = (card) => {
  if (!card.backgroundImage) {
    return {};
  }

  const url = urlFor(card.backgroundImage).height(500).width(345).url();

  return {
    backgroundImage: `linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url(${url})`,
  };
};
---

<section class="swipeables">
  <div class="swipeables-cards">
    {
      cards.map((card, index) => (
        <div class="swipeables-card" style={setStyle(card)}>
          <p>{card.statement}</p>
          {card.source && card.source.url ? (
            <a
              href={card.source.url}
              target="_blank"
              rel="noopener noreferrer"
              class="source"
            >
              Source: {card.source.name} â†—
            </a>
          ) : (
            <span class="source">Source: {card.source.name}</span>
          )}
        </div>
      ))
    }
  </div>

  <div class="swipeables-actions">
    <button class="disagree-button" data-disagree-button>Disagree</button>
    <button class="agree-button" data-agree-button>Agree</button>
  </div>
</section>

<script>
  const container = document.querySelector(".swipeables-cards");
  const allCards = document.querySelectorAll(".swipeables-card");

  function initCards() {
    const newCards = document.querySelectorAll(
      ".swipeables-card:not(.removed)",
    );

    newCards.forEach((card, index) => {
      card.style.zIndex = allCards.length - index;
      card.style.transform = `scale(${(20 - index) / 20}) translateY(-${30 * index}px)`;
      card.style.opacity = (10 - index) / 10;
    });

    container.classList.add("loaded");
  }

  initCards();

  allCards.forEach((card) => {
    let isMoving = false;

    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;
    let lastX = 0;
    let lastY = 0;
    let lastTime = 0;
    let velocityX = 0;
    let velocityY = 0;

    card.addEventListener("pointerdown", (e) => {
      // Check if clicking a link
      if (e.target.tagName === "A") return;

      startX = e.clientX;
      startY = e.clientY;
      lastX = startX;
      lastY = startY;
      lastTime = Date.now();
      isMoving = true;
      card.classList.add("moving");
      card.style.transition = "none"; // Disable transitions during drag
      card.setPointerCapture(e.pointerId);
    });

    card.addEventListener("pointermove", (e) => {
      if (!isMoving) return;

      currentX = e.clientX - startX;
      currentY = e.clientY - startY;

      const rotate = currentX * 0.03 * (currentY / 80);
      card.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rotate}deg)`;

      const opacity = Math.min(Math.abs(currentX) / 100, 0.8);
      card.style.setProperty("--swipe-opacity", opacity);

      // Remove previous classes
      card.classList.remove("swipe-left", "swipe-right");

      // Add appropriate class
      if (currentX > 0) {
        card.classList.add("swipe-right");
      } else {
        card.classList.add("swipe-left");
      }

      const now = Date.now();
      const timeDiff = now - lastTime;

      if (timeDiff > 0) {
        velocityX = (e.clientX - lastX) / timeDiff;
        velocityY = (e.clientY - lastY) / timeDiff;

        lastX = e.clientX;
        lastY = e.clientY;
        lastTime = now;
      }
    });

    card.addEventListener("pointerup", (e) => {
      if (!isMoving) return;

      card.releasePointerCapture(e.pointerId);
      isMoving = false;
      card.classList.remove("moving", "swipe-left", "swipe-right");
      card.style.transition = "transform 0.3s ease-in-out"; // Re-enable transitions

      const moveOutWidth = document.body.clientWidth;
      const keep = Math.abs(currentX) < 80 || Math.abs(velocityX) < 0.5;
      card.classList.toggle("removed", !keep);

      if (keep) {
        card.style.transform = "";
        card.classList.remove("swipe-left", "swipe-right");
        card.style.setProperty("--swipe-opacity", 0);
      } else {
        const endX = Math.max(Math.abs(velocityX) * moveOutWidth, moveOutWidth);
        const toX = currentX > 0 ? endX : -endX;
        const endY = Math.abs(velocityY) * moveOutWidth;
        const toY = currentY > 0 ? endY : -endY;
        const rotate = currentX * 0.03 * (currentY / 80);

        card.style.transform = `translate(${toX}px, ${toY + currentY}px) rotate(${rotate}deg)`;
        initCards();

        if (currentX > 0) {
          const event = new CustomEvent("voted", {
            detail: { card, result: "agree" },
          });
          card.dispatchEvent(event);
        } else {
          const event = new CustomEvent("voted", {
            detail: { card, result: "disagree" },
          });
          card.dispatchEvent(event);
        }
      }
    });

    card.addEventListener("pointercancel", () => {
      if (!isMoving) return;
      isMoving = false;
      card.classList.remove("moving");
      card.style.transition = "transform 0.3s ease-in-out";
      card.style.transform = ""; // Reset the transform to its original state

      // Remove previous classes
      card.classList.remove("swipe-left", "swipe-right");
      card.style.setProperty("--swipe-opacity", 0);
    });

    card.addEventListener("voted", (e) => {
      console.log("Voted", e.detail.result);
    });
  });
</script>

<style>
  .swipeables-cards {
    height: 600px;
    flex-grow: 1;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    position: relative;
    overflow: visible;
  }

  .swipeables-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
  }

  .swipeables-actions > button {
    --bg-color: hsl(0, 0%, 90%);
    padding-inline: 1rem;
    padding-block: 0.5rem;
    font-size: 0.875rem;
    font-family: inherit;
    font-weight: 700;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 0.375rem;
  }

  .swipeables-actions > .disagree-button {
    background-color: hsl(3, 100%, 80%);
  }

  .swipeables-actions > .disagree-button:hover {
    background-color: hsl(3, 100%, 70%);
  }

  .swipeables-actions > .agree-button {
    background-color: hsl(151, 100%, 72%);
  }

  .swipeables-actions > .agree-button:hover {
    background-color: hsl(151, 100%, 72%);
  }

  .swipeables-cards.loaded {
    opacity: 1;
  }

  .swipeables-card.removed {
    display: none;
  }

  .swipeables-card {
    display: inline-flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: flex-start;

    width: 345px;
    height: 500px;

    margin-top: 24px;
    padding: 1.5rem;
    padding-bottom: 2rem;

    border-radius: 1rem;
    overflow: hidden;
    position: absolute;

    will-change: transform;
    transition: transform 0.3s ease-in-out;
    cursor: grab;
    background: orange;
    color: white;
    z-index: 10000;

    font-size: 2rem;
    font-weight: 700;
    text-wrap: pretty;

    background: black;
    background-size: cover;
    background-position: center;
  }

  .swipeables-card::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: transparent;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
    z-index: 1;
  }

  /* For right swipe (green) */
  .swipeables-card.swipe-right::after {
    background-color: hsla(120, 100%, 50%, 0.4);
    opacity: var(--swipe-opacity, 0);
  }

  /* For left swipe (red) */
  .swipeables-card.swipe-left::after {
    background-color: hsla(0, 100%, 50%, 0.4);
    opacity: var(--swipe-opacity, 0);
  }

  .swipeables-card .source {
    display: block;
    margin-top: 16px;
    font-size: 16px;
    color: white;
  }

  .swipeables-card a.source {
    text-decoration: underline;
  }

  .swipeables-card.moving {
    transition: none;
    cursor: grabbing;
  }

  .swipeables-card img {
    max-width: 100%;
    pointer-events: none;
  }

  .swipeables-card p {
    margin: 0px;
  }
</style>
